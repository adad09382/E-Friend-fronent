import{aE as D,x as t,z as q,a5 as v}from"./index-5ef22765.js";import{u as x}from"./index-06655b42.js";const j=D("conversations",()=>{const p=t(""),L=async(o,e)=>{console.log(`創建話題，話題的topic為：${o}`),console.log(`創建話題，話題的prompt為：${e}`);try{const g=(await v.post("/conversation",{topic:o,prompt:e})).data.result;return console.log(g),g}catch(s){console.log("失敗"),console.log(s)}},h=t([]),C=t({_id:"",user:"",history:[{}]}),U=async()=>{try{console.log("開始get 指定User Id的所有conversation");const{data:o}=await v.get("/conversation");console.log(o.result),h.value=o.result}catch(o){console.log("get 指定User Id的所有conversation失敗"),console.log(o),createSnackbar({text:o.response.data.message,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}};let m=t([]);const F=o=>{console.log("開始從conversations中找尋指定id的history");const e=h.value.find(s=>s._id===o);m.value=e?e.history:[],a.value=m.value.slice(),a.value.shift()},n=t(""),a=t([]),w=t(!1),r=new FormData;async function f(){await A(),await b()}const A=async()=>{try{if(n.value.length<3){console.log("question的內容小於3");return}r.append("role","user"),r.append("content",n.value),console.log("向後端傳送修改請求");const{data:o}=await v.patch("/conversation/"+p.value,r),e=o.result.history[o.result.history.length-1],s=e.role,g=e==null?void 0:e.audioLink;a.value.push({role:s,content:n.value,audioLink:g}),n.value=""}catch(o){console.log("向後端傳送修改請求，失敗"),console.log(o)}},b=async()=>{try{w.value=!0,a.value.push({role:"assistant",content:"Loading...."}),console.log("向gpt發出請求");const o=await v.patch("/conversation/"+p.value+"/response");console.log(o),a.value.pop(),a.value.push({role:"assistant",content:o.data.result.history[o.data.result.history.length-1].content})}catch(o){console.log("獲取AI回覆失敗"),console.log(o)}finally{w.value=!1}},I=()=>new Promise(o=>{setTimeout(()=>{o("3秒過去了")},3e3)}),$=o=>{const e=[...o.keys()];if(e.length>0){console.log("刪除fd的role & content");for(const s of e)o.delete(s)}else console.log("fd是空的不用清空")},l=t(!1),M=()=>{console.log(`開始切換語音狀態，將語音狀態由${l.value}切換為${!l.value}`),l.value=!l.value,B(),S()};let c,u=[],R=t(null);const S=async()=>{if(l.value)try{console.log("開始錄音，創建錄音實例");const o=await navigator.mediaDevices.getUserMedia({audio:!0});c=new MediaRecorder(o),c.addEventListener("dataavailable",e=>u.push(e.data)),c.start()}catch(o){console.error("錄音失敗：",o)}else c.onstop=async()=>{console.log("將錄製的recordedChunks 製作成audio/webm 的blob");const o=new Blob(u,{type:"audio/webm"});console.log("製作Blob錄音檔url"),R.value=URL.createObjectURL(o),u=[],k(o)},console.log("錄音結束"),c.stop()},k=async o=>{console.log("將audio/webm 的blob寫成audio/webm files");const e=`recorded_${Date.now()}_${Math.floor(Math.random()*1e4)}.webm`,s=new File([o],e,{type:"audio/webm"});$(r),console.log("將audio/webm加入到FormData中"),r.append("audio",s),f()},_=t("en-US"),y=t(""),i=x({lang:_.value,interimResults:!0,continuous:!0}),{isSupported:G,isListening:E,isFinal:H,result:d}=i;if(i.isSupported.value){const o=window.SpeechGrammarList||window.webkitSpeechGrammarList,e=new o;i.recognition.grammars=e}q(d,()=>{console.log(d.value),n.value=d.value});const B=()=>{l.value?(console.log("點擊了開始錄音按鈕"),i.result.value="",i.start()):(console.log("點擊了結束錄音按鈕"),i.stop(),y.value=d.value,console.log("最後語音識別結果為： "+y.value),n.value=y.value)};return{Conversation_Id:p,conversation:C,conversations:h,createConversation:L,getUserIdAllConversation:U,findConversationIdHistory:F,conversationIdHistory:m,question:n,wrapper:a,loading:w,waitThreeSeconds:I,audioRunning:l,recorder:c,recordedChunks:u,audioUrl:R,toggleRecording:S,createAudioFileFromRecordedBlob:k,startRecordAndRecognition:M,handleChat:f,fetchAiResponse:b,fd:r}});export{j as u};
