import{aC as D,x as t,z as q,a4 as g}from"./index-4ee9dc64.js";import{u as x}from"./index-6800cd96.js";const z=D("conversations",()=>{const v=t(""),L=async(o,e)=>{console.log(`創建話題，話題的topic為：${o}`),console.log(`創建話題，話題的prompt為：${e}`);try{const d=(await g.post("/conversation",{topic:o,prompt:e})).data.result;return console.log(d),d}catch(s){console.log("失敗"),console.log(s)}},p=t([]),C=t({_id:"",user:"",history:[{}]}),U=async()=>{try{console.log("開始get 指定User Id的所有conversation");const{data:o}=await g.get("/conversation");console.log(o.result),p.value=o.result}catch(o){console.log("get 指定User Id的所有conversation失敗"),console.log(o),createSnackbar({text:o.response.data.message,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}};let h=t([]);const F=o=>{console.log("開始從conversations中找尋指定id的history");const e=p.value.find(s=>s._id===o);h.value=e?e.history:[],n.value=h.value.slice(),n.value.shift()},l=t(""),n=t([]),m=t(!1),r=new FormData;async function f(){await A(),await b()}const A=async()=>{try{if(l.value.length<3){console.log("question的內容小於3");return}r.append("role","user"),r.append("content",l.value),console.log("向後端傳送修改請求");const{data:o}=await g.patch("/conversation/"+v.value,r),e=o.result.history[o.result.history.length-1],s=e.role,d=e==null?void 0:e.audioLink;n.value.push({role:s,content:l.value,audioLink:d}),l.value=""}catch(o){console.log("向後端傳送修改請求，失敗"),console.log(o)}},b=async()=>{try{m.value=!0,n.value.push({role:"assistant",content:"Loading...."}),console.log("向gpt發出請求");const o=await g.patch("/conversation/"+v.value+"/response");console.log(o),n.value.pop(),n.value.push({role:"assistant",content:o.data.result.history[o.data.result.history.length-1].content})}catch(o){console.log("獲取AI回覆失敗"),console.log(o)}finally{m.value=!1}},I=()=>new Promise(o=>{setTimeout(()=>{o("3秒過去了")},3e3)}),$=o=>{const e=[...o.keys()];if(e.length>0){console.log("刪除fd的role & content");for(const s of e)o.delete(s)}else console.log("fd是空的不用清空")},a=t(!1),M=()=>{console.log(`開始切換語音狀態，將語音狀態由${a.value}切換為${!a.value}`),a.value=!a.value,B(),S()};let c,u=[],R=t(null);const S=async()=>{if(a.value)try{console.log("開始錄音，創建錄音實例");const o=await navigator.mediaDevices.getUserMedia({audio:!0});c=new MediaRecorder(o),c.addEventListener("dataavailable",e=>u.push(e.data)),c.start()}catch(o){console.error("錄音失敗：",o)}else c.onstop=async()=>{console.log("將錄製的recordedChunks 製作成audio/webm 的blob");const o=new Blob(u,{type:"audio/webm"});console.log("製作Blob錄音檔url"),R.value=URL.createObjectURL(o),u=[],k(o)},console.log("錄音結束"),c.stop()},k=async o=>{console.log("將audio/webm 的blob寫成audio/webm files");const e=`recorded_${Date.now()}_${Math.floor(Math.random()*1e4)}.webm`,s=new File([o],e,{type:"audio/webm"});$(r),console.log("將audio/webm加入到FormData中"),r.append("audio",s),f()},_=t("en-US"),w=t(""),i=x({lang:_.value,interimResults:!0,continuous:!0}),{isSupported:G,isListening:H,isFinal:P,result:y}=i;if(i.isSupported.value){const o=window.SpeechGrammarList||window.webkitSpeechGrammarList,e=new o;i.recognition.grammars=e}q(y,()=>{console.log(y.value)});const B=()=>{a.value?(console.log("點擊了開始錄音按鈕"),i.result.value="",i.start()):(console.log("點擊了結束錄音按鈕"),i.stop(),w.value=y.value,console.log("最後語音識別結果為： "+w.value),l.value=w.value)};return{Conversation_Id:v,conversation:C,conversations:p,createConversation:L,getUserIdAllConversation:U,findConversationIdHistory:F,conversationIdHistory:h,question:l,wrapper:n,loading:m,waitThreeSeconds:I,audioRunning:a,recorder:c,recordedChunks:u,audioUrl:R,toggleRecording:S,createAudioFileFromRecordedBlob:k,startRecordAndRecognition:M,handleChat:f,fetchAiResponse:b,fd:r}});export{z as u};
