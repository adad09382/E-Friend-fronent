import{x as g,A as Y,av as Z,aI as G,R as f,S as y,X as x,aa as e,W as Q,aJ as H,aK as F,a5 as S,c,$ as b,a1 as K,ah as q,ai as J,aL as ee,O as te,N as ne,z as oe,o as B,T as _,a3 as se,a8 as ae,_ as z,ac as E,ad as N,ae as le,aM as ie,aN as ce,Y as R,af as re,K as ue,a0 as de,a2 as ve,a9 as pe,U as _e,aO as me,H as fe}from"./index-1ad04715.js";import{_ as W}from"./_plugin-vue_export-helper-c27b6911.js";import{u as he}from"./conversations-80eba0cf.js";import{V as ge,a as ye}from"./VRow-95b84b44.js";import"./index-f53e1177.js";const be=""+new URL("user-bcdeb18e.svg",import.meta.url).href,Ce=""+new URL("bot-61bdb6bf.svg",import.meta.url).href;const U=a=>(q("data-v-06bdfd97"),a=a(),J(),a),Se={class:"message",style:{"text-align":"end"}},ke=["src"],we={class:"audio-text"},Ie=U(()=>e("div",{class:"profile"},[e("img",{src:be,alt:""})],-1)),xe=U(()=>e("div",{class:"profile",style:{"background-color":"#19c37d"}},[e("img",{src:Ce,alt:""})],-1)),Ve={key:0,class:"message"},Re={class:"audio-text"},Te={key:1,class:"message"},$e={class:"controls"},De={class:"play-container"},Ae={class:"time"},Oe={class:"current"},Le=U(()=>e("div",{class:"divider"},"/",-1)),Ue={class:"length"},Me={class:"volume-container"},Pe={class:"volume-button"},je=U(()=>e("div",{class:"volume-slider"},[e("div",{class:"volume-percentage"})],-1)),Be={class:"audio-text"},Ne={__name:"Chat",props:{role:String,content:String,audioLink:String},setup(a){const V=a,$=g(null);g(null);const d=g(!1);Y(async()=>{await Z(),$.value.scrollIntoView({behavior:"smooth"})});const h=g(null);g(null);const r=window.speechSynthesis;let w=[],D=null;r.onvoiceschanged=function(){w=r.getVoices(),D=w.find(t=>t.name==="Microsoft Zira - English (United States)")};const u=G({start:"0",end:"1",pause:"2",resume:"3"});let k=null,I=g("0:00"),M=g(null);const v=g(u.end),A=P(()=>{if(v.value===u.start)console.log("暫停合成"),r.pause();else if(v.value===u.pause)console.log("恢復合成"),r.resume();else if(v.value===u.end){(r.speaking||v.value===u.pause)&&(console.log("已有語音合成物件在序列中，取消前一序列"),r.cancel(),v.value=u.end),console.log("製作合成並撥放");let t=null,n=null,m=0,p=null;const l=new SpeechSynthesisUtterance;l.text=V.content,l.lang="en-US",l.voice=D,l.rate=1.5,l.pitch=1,l.volume=.8,l.onstart=()=>{console.log("觸發 start 事件"),k=setInterval(L,1e3),v.value=u.start,t=Date.now()},l.onresume=()=>{console.log("觸發resume 事件"),k=setInterval(L,1e3),v.value=u.start,n&&(m+=Date.now()-n,n=null)},l.onend=()=>{console.log("觸發 end 事件"),clearInterval(k),I.value="0:00",v.value=u.end,p=Date.now(),M.value=O(p-t-m)},l.onpause=()=>{console.log("觸發 pause 事件"),clearInterval(k),v.value=u.pause,n=Date.now()},l.onerror=o=>{console.log("語音合成出錯:",o),v.value=u.end,r.cancel()},r.speaking&&r.cancel(),setTimeout(()=>{r.speak(l)},200)}},500);function P(t,n){let m,p;return function(...l){p?(clearTimeout(m),m=setTimeout(function(){Date.now()-p>=n&&(t(...l),p=Date.now())},n-(Date.now()-p))):(t(...l),p=Date.now())}}function O(t){const n=Math.floor(t/1e3),m=Math.floor(n/60),p=n%60;return`${m}:${p.toString().padStart(2,"0")}`}const L=()=>{let t=parseInt(I.value.split(":")[1],10),n=parseInt(I.value.split(":")[0],10);t++,t>=60&&(t=0,n++),I.value=`${n.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`};return(t,n)=>(f(),y("div",{class:"chat",ref_key:"currentMessage",ref:$},[a.role!=="assistant"?(f(),y(x,{key:0},[e("div",Se,[a.audioLink?(f(),y("audio",{key:0,src:a.audioLink,controls:""},null,8,ke)):Q("",!0),e("div",we,[H(e("span",null,S(a.content),513),[[F,!d.value]]),e("button",{class:"btn",onClick:n[0]||(n[0]=m=>d.value=!d.value)},"文")])]),Ie],64)):(f(),y(x,{key:1},[xe,a.content==="Loading...."?(f(),y("div",Ve,[e("div",Re,S(a.content),1)])):(f(),y("div",Te,[e("div",{class:"audio-player",ref_key:"audioPlayer",ref:h},[e("div",$e,[e("div",De,[c(K,{onClick:b(A),icon:v.value===u.start?"mdi-pause":"mdi-play",size:"x-large"},null,8,["onClick","icon"])]),e("div",Ae,[e("div",Oe,S(b(I)),1),Le,e("div",Ue,S(b(M)),1)]),e("div",Me,[e("div",Pe,[c(K,{class:"volume",icon:"mdi-volume-high",size:"x-large"})]),je])])],512),e("div",Be,[e("button",{class:"bot-btn",onClick:n[1]||(n[1]=m=>d.value=!d.value)},"文"),H(e("span",null,S(a.content),513),[[F,d.value]])])]))],64))],512))}},He=W(Ne,[["__scopeId","data-v-06bdfd97"]]);const T=a=>(q("data-v-493db9aa"),a=a(),J(),a),Fe={class:"text-center"},Ke=T(()=>e("b",null,"Situation",-1)),ze=T(()=>e("br",null,null,-1)),Ee=T(()=>e("br",null,null,-1)),qe=T(()=>e("b",null,"Object",-1)),Je=T(()=>e("br",null,null,-1)),We={__name:"ConversationView",setup(a){const V=ee(),$=te(),d=g(!1),h=he(),{Conversation_Id:r,conversations:w,audioRunning:D,question:u,wrapper:k,loading:I,audioUrl:M,conversationIdHistory:v,fd:X}=ne(h);h.getIdConversation;const A=h.getUserIdAllConversation,P=h.startRecordAndRecognition,O=h.handleChat,L=h.fetchAiResponse;h.waitThreeSeconds;const t=h.findConversationIdHistory,n=g(V.params.id);r.value=n.value,t(r.value),oe(()=>V.params.id,async o=>{console.log("監控到route路徑改變"),r.value=o,await A(),t(o)});const m=B(()=>{const o=w.value.find(j=>j._id===r.value);if(!o||!o.history[0]||!o.history[0].content)return null;const s=o.history[0].content,i=s.indexOf("Situation:"),C=s.indexOf("Objective:");return i!==-1&&C!==-1?s.substring(i+10,C).trim():null}),p=B(()=>{const o=w.value.find(j=>j._id===r.value);if(!o||!o.history[0]||!o.history[0].content)return null;const s=o.history[0].content,i=s.indexOf("Objective:"),C=s.indexOf("Note:");return i!==-1&&C!==-1?s.substring(i+10,C).trim():null}),l=B(()=>w.value.slice().sort((o,s)=>new Date(s.updatedAt)-new Date(o.updatedAt)));return(async()=>{try{console.log("開始執行IIFE"),await A(),t(V.params.id),k.value.length===0&&await L()}catch(o){console.log("前端IIFE失敗"),console.log(o),$({text:o.response.data.message,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}})(),(o,s)=>(f(),y(x,null,[c(se,{class:"conversation-list"},{default:_(()=>[(f(!0),y(x,null,z(l.value,(i,C)=>(f(),y(x,{key:i._id},[c(de,{to:i._id},{default:_(()=>[c(ve,{textContent:S(i.topic)},null,8,["textContent"])]),_:2},1032,["to"]),c(pe,{class:"my-0"})],64))),128))]),_:1}),c(ge,{class:"chat-container"},{default:_(()=>[c(ye,{class:"chat-content"},{default:_(()=>[c(E,{flat:"",class:"chat-card"},{default:_(()=>[c(N,{class:"chat-text"},{default:_(()=>[(f(!0),y(x,null,z(b(k),(i,C)=>(f(),_e(He,me(fe({key:C},i)),null,16))),128))]),_:1}),c(N,{class:"input-field"},{default:_(()=>[e("button",{class:"promptBtn",onClick:s[0]||(s[0]=i=>d.value=!d.value)},"P"),c(le,{modelValue:b(u),"onUpdate:modelValue":s[1]||(s[1]=i=>ie(u)?u.value=i:null),label:"type_a_message",type:"text",outlined:"","append-inner-icon":"mdi-send","onClick:appendInner":b(O),onKeyup:ce(b(O),["enter"]),"append-icon":b(D)?"mdi-microphone-off":"mdi-microphone","onClick:append":b(P),"hide-details":""},null,8,["modelValue","onClick:appendInner","onKeyup","append-icon","onClick:append"])]),_:1})]),_:1})]),_:1})]),_:1}),e("div",Fe,[c(ae,{modelValue:d.value,"onUpdate:modelValue":s[3]||(s[3]=i=>d.value=i),activator:"parent",width:"auto"},{default:_(()=>[c(E,null,{default:_(()=>[c(N,null,{default:_(()=>[Ke,R(),ze,R(" "+S(m.value)+" ",1),Ee,qe,R(),Je,R(" "+S(p.value),1)]),_:1}),c(re,null,{default:_(()=>[c(ue,{color:"primary",block:"",onClick:s[2]||(s[2]=i=>d.value=!1)},{default:_(()=>[R("Close Dialog")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])])],64))}},et=W(We,[["__scopeId","data-v-493db9aa"]]);export{et as default};
